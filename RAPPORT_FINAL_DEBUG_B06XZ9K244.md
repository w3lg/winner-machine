# üîç Rapport Final de Debug : ASIN B06XZ9K244

## üìã R√©sum√© Ex√©cutif

**Probl√®me :** Le produit B06XZ9K244 a `approx_profit_per_day: 6.2055` (>= 5.0) mais `decision: "B_review"` au lieu de "A_launch".

**Objectif :** D√©boguer √† 100% la s√©quence de d√©cision pour cet ASIN.

---

## 1. Contenu de scoring_rules.yml sur marcus

**Fichier :** `/root/winner-machine/backend/app/config/scoring_rules.yml`

```yaml
min_margin_percent: 10
min_global_score_A: 50
min_global_score_B: 20
use_profit_per_day_rules: true
min_profit_per_day_A: 5.0  # EUR/jour minimum pour A_launch
min_profit_per_day_B: 1.0  # EUR/jour minimum pour B_review
```

‚úÖ **Configuration correcte** : La r√®gle profit/jour est bien activ√©e.

---

## 2. Stats apr√®s relance du scoring

**Commande ex√©cut√©e :**
```bash
curl -X POST "http://localhost:8000/api/v1/jobs/scoring/run?force=true"
```

**R√©sultats :**
- ‚úÖ `pairs_scored: 65`
- ‚ùå `products_marked_selected: 0` (aucun A_launch)
- ‚úÖ `products_marked_scored: 2` (B_review)
- ‚úÖ `products_marked_rejected: 63` (C_drop)

---

## 3. Donn√©es du produit B06XZ9K244 (Winner Dashboard)

**ASIN :** B06XZ9K244

```json
{
  "asin": "B06XZ9K244",
  "title": "magilano SKYJO, Fun Card Game for Young and Least Young, Fun Game Parties in The Circle of Friends and Family.",
  "category": "France",
  "supplier_name": "AutoGenerated Supplier",
  "purchase_price": "5.99",
  "selling_price_target": "19.98",
  "amazon_fees_estimate": "7.50",
  "margin_absolute": "4.49",
  "margin_percent": "22.49",
  "gross_profit": "4.49",
  "gross_margin_percent": "22.49",
  "net_profit_estimated": "3.15",
  "estimated_sales_per_day": "1.97",
  "approx_profit_per_day": "6.2055",
  "global_score": "59.81",
  "decision": "B_review",
  "is_real_asin": true
}
```

---

## 4. V√©rification DB

**Nombre de ProductScore pour B06XZ9K244 :** ‚úÖ **1** (correct, pas de doublon)

---

## 5. Logs ajout√©s dans ScoringService

Les logs suivants ont √©t√© ajout√©s :

1. **Lors du chargement de scoring_rules.yml** (toujours visible) :
   - `=== CHARGEMENT scoring_rules.yml ===`
   - Toutes les valeurs de configuration

2. **Pour B06XZ9K244 sp√©cifiquement** :
   - `=== DEBUG B06XZ9K244: Configuration scoring_rules.yml ===`
   - `=== DEBUG B06XZ9K244: Valeurs calcul√©es ===`
   - `=== DEBUG B06XZ9K244: Seuils utilis√©s ===`
   - `=== DEBUG B06XZ9K244: Application r√®gle profit/jour ===`
   - `=== DEBUG B06XZ9K244: DECISION FINALE CHOISIE = {decision} ===`

**Note :** Les logs ne sont pas encore visibles dans les logs Docker. Il faut relancer le scoring pour qu'ils apparaissent.

---

## 6. Analyse du probl√®me

### ‚úÖ Valeurs calcul√©es (toutes correctes)

- `margin_percent: 22.49%` (>= 10% ‚úÖ)
- `approx_profit_per_day: 6.2055 EUR` (>= 5.0 ‚úÖ)
- `net_profit_estimated: 3.15 EUR`
- `estimated_sales_per_day: 1.97`
- `global_score: 59.81` (>= 50 ‚úÖ)

### ‚ùå D√©cision (incorrecte)

- `decision: "B_review"` 
- **Devrait √™tre : "A_launch"** car `approx_profit_per_day (6.2055) >= min_profit_per_day_A (5.0)`

### üîç Hypoth√®ses

1. **Le cache de configuration n'est pas invalid√©** : Le service ScoringService met en cache `_scoring_rules` et ne le recharge peut-√™tre pas.
2. **La r√®gle profit/jour n'est pas appliqu√©e** : Peut-√™tre que `use_profit_per_day_rules` n'est pas correctement charg√©.
3. **Le calcul de `approx_profit_per_day` n'est pas fait** : Peut-√™tre que `approx_profit_per_day` est None dans ScoringService.

---

## 7. Prochaines √©tapes

1. **Relancer le scoring** apr√®s avoir invalid√© le cache
2. **R√©cup√©rer les logs d√©taill√©s** pour B06XZ9K244 depuis les logs Docker
3. **V√©rifier dans les logs** :
   - Le contenu exact de `scoring_rules.yml` charg√©
   - Les valeurs calcul√©es pour B06XZ9K244
   - La s√©quence de d√©cision compl√®te
   - La raison pour laquelle la r√®gle profit/jour n'est pas appliqu√©e

---

## 8. Commandes pour r√©cup√©rer les logs

```bash
# Sur marcus
cd /root/winner-machine/infra

# Relancer le scoring
curl -X POST "http://localhost:8000/api/v1/jobs/scoring/run?force=true"

# R√©cup√©rer les logs pour B06XZ9K244
docker compose logs app 2>&1 | grep -E "CHARGEMENT|DEBUG B06XZ9K244|B06XZ9K244.*DECISION" | tail -100

# Ou tous les logs r√©cents
docker compose logs app --tail 1000 2>&1 | grep -E "CHARGEMENT|DEBUG|B06XZ9K244" | tail -100
```

---

## 9. Script de debug cr√©√©

Le script `debug_b06xzk244.sh` a √©t√© cr√©√© et d√©ploy√© sur marcus pour automatiser la r√©cup√©ration des informations.

