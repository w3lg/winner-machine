version: '3.8'

services:
  # Base de données PostgreSQL
  db:
    image: postgres:16-alpine
    container_name: winner-machine-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-winner_machine}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-winner_machine_dev}
      POSTGRES_DB: ${POSTGRES_DB:-winner_machine}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-winner_machine}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - winner-machine-network

  # Backend FastAPI
  app:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: winner-machine-app
    environment:
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-winner_machine}:${POSTGRES_PASSWORD:-winner_machine_dev}@db:5432/${POSTGRES_DB:-winner_machine}
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-winner_machine}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-winner_machine_dev}
      POSTGRES_DB: ${POSTGRES_DB:-winner_machine}
      
      # App settings
      APP_ENV: ${APP_ENV:-dev}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      
      # API Keys (à définir dans .env)
      KEEPA_API_KEY: ${KEEPA_API_KEY:-}
      AMAZON_SP_API_CLIENT_ID: ${AMAZON_SP_API_CLIENT_ID:-}
      AMAZON_SP_API_CLIENT_SECRET: ${AMAZON_SP_API_CLIENT_SECRET:-}
      KEYBUZZ_API_KEY: ${KEYBUZZ_API_KEY:-}
      APIFY_API_KEY: ${APIFY_API_KEY:-}
    volumes:
      - app_data:/app/data
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    networks:
      - winner-machine-network
    restart: unless-stopped

  # n8n Workflow Automation
  n8n:
    image: n8nio/n8n:latest
    container_name: winner-machine-n8n
    environment:
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-admin}
      - N8N_HOST=${N8N_HOST:-n8n.w3lg.fr}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - GENERIC_TIMEZONE=Europe/Paris
      - TZ=Europe/Paris
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=db
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${N8N_DB_NAME:-n8n}
      - DB_POSTGRESDB_USER=${POSTGRES_USER:-winner_machine}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD:-winner_machine_dev}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-change-me-in-production}
    volumes:
      - n8n_data:/home/node/.n8n
      - ../n8n/workflows:/home/node/.n8n/workflows
    ports:
      - "5678:5678"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - winner-machine-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  app_data:
    driver: local
  n8n_data:
    driver: local

networks:
  winner-machine-network:
    driver: bridge

